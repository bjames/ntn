<p>In the past when I was using TCL/Expect as my primary automation language, I would do most of my configuration within the script itself and then I’d just have the script grab a list of devices from a text document. Lately, I’ve been using YAML to provide both my list of devices and to configure various parameters within the script itself.</p>
<h3 id="the-yaml-file">The YAML file</h3>
<p>I’m not going to go into the details of what YAML is, or how exactly it works. Because it’s incredibly easy to pick up, if you don’t get the gist of it from my examples or just want more details, checkout <a href="https://yaml.org/">yaml.org</a> and the <a href="https://en.wikipedia.org/wiki/YAML">wikipedia entry on YAML</a>. I’m using my <a href="https://github.com/bjames/ios_upgrade">IOS Upgrade script’s</a> YAML file as an example.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">email_recipient</span><span class="kw">:</span><span class="at"> brandon@brandonsjames.com</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># specify how many devices to upgrade at a single time (note, this is also the number of threads spawned at runtime)</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">threads</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># disruptive parts of the script will run at this time, leave blank to run immediately. Format HH:MM</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">change_time</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;23:00&#39;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># if set to true, the new image will copied to the device prior to the change</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">pre_copy</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># default settings that may be overridden on a per device basis</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">default</span><span class="kw">:</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">  # directory storing the IOS image</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="at">  </span><span class="fu">remote_directory</span><span class="kw">:</span><span class="at"> http://192.168.0.113/</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">  # full IOS/NXOS filename (ie c3560cx-universalk9-mz.152-4.E4.bin)</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="at">  </span><span class="fu">image_name</span><span class="kw">:</span><span class="at"> c2960-lanlitek9-mz.122-55.SE12.bin</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">  # md5 may be left blank to skip verification</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="at">  </span><span class="fu">image_md5</span><span class="kw">:</span><span class="at"> 1ac4728753bb11ad6f22fd8f54763f8e</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">  # if true, invalid confregs will be set to 0x2102. Otherwise an exception will be raised. </span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="at">  </span><span class="fu">fix_confreg</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">  # if true, device will be reloaded. If false code will only be copied</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="at">  </span><span class="fu">install</span><span class="kw">:</span><span class="at"> </span><span class="ch">True</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">  # maximum amount of time to wait (in seconds) before throwing an exception after reload command has been issued</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="at">  </span><span class="fu">reload_max_time</span><span class="kw">:</span><span class="at"> </span><span class="dv">24000</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">  # some device images may not support the reload /verify command. It can be disabled here.</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="at">  </span><span class="fu">reload_verify</span><span class="kw">:</span><span class="at"> </span><span class="ch">False</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">  # perform a shelf reload for dual SUP devices in RPR mode</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="at">  </span><span class="fu">reload_shelf_rpr</span><span class="kw">:</span><span class="at"> </span><span class="ch">False</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">  # acceptable confreg settings</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="at">  </span><span class="fu">confreg</span><span class="kw">:</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">&#39;0xF&#39;</span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">&#39;0x2102&#39;</span></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">&#39;0x102&#39;</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="co"># list devices and device specific config</span></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="fu">target_devices</span><span class="kw">:</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="at"> </span><span class="kw">-</span><span class="at"> </span><span class="fu">hostname</span><span class="kw">:</span><span class="at"> </span><span class="fl">192.168.0.150</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="at">   </span><span class="fu">image_name</span><span class="kw">:</span><span class="at"> c2960-lanlitek9-mz.150-2.SE11.bin</span></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="at">   </span><span class="fu">image_md5</span><span class="kw">:</span><span class="at"> 885ed3dd7278baa11538a51827c2c9f8</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="at"> </span><span class="kw">-</span><span class="at"> </span><span class="fu">hostname</span><span class="kw">:</span><span class="at"> </span><span class="fl">192.168.0.11</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="at"> </span><span class="kw">-</span><span class="at"> </span><span class="fu">hostname</span><span class="kw">:</span><span class="at"> </span><span class="fl">192.168.10.11</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="at">   </span><span class="fu">install</span><span class="kw">:</span><span class="at"> </span><span class="ch">False</span></span></code></pre></div>
<p>As you can see, I allow device specific configuration for a number of settings. I’ve found this to really increase the flexibility of my scripts. Generally, I try to make my scripts as reusable as possible and this type of flexibility keeps me from needing to write separate scripts for slight changes in device types or use cases. As you write your script you’ll need to think about what can and cannot be different on a per device basis.</p>
<h3 id="the-python-script">The Python Script</h3>
<p>I load all the values from the YAML file into a python dictionary. I then use a function called merge_settings() to combine the default settings from the YAML with any device specific overrides and place the results into a list of dictionaries:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> yaml</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">def</span> merge_settings(device, script_config):</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="co">&#39;&#39;&#39; merges the default and device specific dictionaries &#39;&#39;&#39;</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>    script_settings <span class="op">=</span> script_config[<span class="st">&#39;default&#39;</span>].copy()</span>
<span id="cb2-10"><a href="#cb2-10"></a>    script_settings.update(device)</span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="cf">return</span> script_settings</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="kw">def</span> set_script_settings(script_config):</span>
<span id="cb2-16"><a href="#cb2-16"></a></span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="co">&#39;&#39;&#39;</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">        creates an array of devices containing device specific</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">        script configuration</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">    &#39;&#39;&#39;</span> </span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a>    script_settings <span class="op">=</span> []</span>
<span id="cb2-23"><a href="#cb2-23"></a>    </span>
<span id="cb2-24"><a href="#cb2-24"></a>    <span class="cf">for</span> device <span class="kw">in</span> script_config[<span class="st">&#39;target_devices&#39;</span>]:</span>
<span id="cb2-25"><a href="#cb2-25"></a></span>
<span id="cb2-26"><a href="#cb2-26"></a>        device_settings <span class="op">=</span> merge_settings(device, script_config)</span>
<span id="cb2-27"><a href="#cb2-27"></a>        script_settings.append(device_settings)</span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a>    <span class="cf">return</span> script_settings</span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a></span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="kw">def</span> main():</span>
<span id="cb2-33"><a href="#cb2-33"></a></span>
<span id="cb2-34"><a href="#cb2-34"></a>    <span class="co"># pull data from config file</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>    script_config <span class="op">=</span> yaml.safe_load(<span class="bu">open</span>(<span class="st">&quot;script_config.yml&quot;</span>))</span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a></span>
<span id="cb2-38"><a href="#cb2-38"></a>    <span class="bu">print</span>(<span class="st">&#39;________________RAW DICT______________&#39;</span>)</span>
<span id="cb2-39"><a href="#cb2-39"></a>    pprint(script_config)</span>
<span id="cb2-40"><a href="#cb2-40"></a></span>
<span id="cb2-41"><a href="#cb2-41"></a>    script_settings <span class="op">=</span> set_script_settings(script_config)</span>
<span id="cb2-42"><a href="#cb2-42"></a></span>
<span id="cb2-43"><a href="#cb2-43"></a>    <span class="bu">print</span>(<span class="st">&#39;_______________MERGED DICT_____________&#39;</span>)</span>
<span id="cb2-44"><a href="#cb2-44"></a>    pprint(script_settings)</span>
<span id="cb2-45"><a href="#cb2-45"></a>    </span>
<span id="cb2-46"><a href="#cb2-46"></a>main()</span></code></pre></div>
<p><em>Note: pprint is only included to print our dictionary and list of dictionaries to the screen</em></p>
<p>When this script is executed the following is output on the terminal:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a>[<span class="ex">bjames@lws1</span> ~]$ venv3/bin/python import_script_settings.py </span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">________________RAW</span> DICT______________</span>
<span id="cb3-3"><a href="#cb3-3"></a>{<span class="st">&#39;change_time&#39;</span>: <span class="st">&#39;23:00&#39;</span>,</span>
<span id="cb3-4"><a href="#cb3-4"></a> <span class="st">&#39;default&#39;</span>: {<span class="st">&#39;confreg&#39;</span>: [<span class="st">&#39;0xF&#39;</span>, <span class="st">&#39;0x2102&#39;</span>, <span class="st">&#39;0x102&#39;</span>],</span>
<span id="cb3-5"><a href="#cb3-5"></a>             <span class="st">&#39;fix_confreg&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-6"><a href="#cb3-6"></a>             <span class="st">&#39;image_md5&#39;</span>: <span class="st">&#39;1ac4728753bb11ad6f22fd8f54763f8e&#39;</span>,</span>
<span id="cb3-7"><a href="#cb3-7"></a>             <span class="st">&#39;image_name&#39;</span>: <span class="st">&#39;c2960-lanlitek9-mz.122-55.SE12.bin&#39;</span>,</span>
<span id="cb3-8"><a href="#cb3-8"></a>             <span class="st">&#39;install&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-9"><a href="#cb3-9"></a>             <span class="st">&#39;reload_max_time&#39;</span>: <span class="ex">24000</span>,</span>
<span id="cb3-10"><a href="#cb3-10"></a>             <span class="st">&#39;reload_shelf_rpr&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-11"><a href="#cb3-11"></a>             <span class="st">&#39;reload_verify&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-12"><a href="#cb3-12"></a>             <span class="st">&#39;remote_directory&#39;</span>: <span class="st">&#39;http://192.168.0.113/&#39;</span>},</span>
<span id="cb3-13"><a href="#cb3-13"></a> <span class="st">&#39;email_recipient&#39;</span>: <span class="st">&#39;brandon@brandonsjames.com&#39;</span>,</span>
<span id="cb3-14"><a href="#cb3-14"></a> <span class="st">&#39;pre_copy&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-15"><a href="#cb3-15"></a> <span class="st">&#39;target_devices&#39;</span>: [{<span class="st">&#39;hostname&#39;</span>: <span class="st">&#39;192.168.0.150&#39;</span>,</span>
<span id="cb3-16"><a href="#cb3-16"></a>                     <span class="st">&#39;image_md5&#39;</span>: <span class="st">&#39;885ed3dd7278baa11538a51827c2c9f8&#39;</span>,</span>
<span id="cb3-17"><a href="#cb3-17"></a>                     <span class="st">&#39;image_name&#39;</span>: <span class="st">&#39;c2960-lanlitek9-mz.150-2.SE11.bin&#39;</span>},</span>
<span id="cb3-18"><a href="#cb3-18"></a>                    {<span class="st">&#39;hostname&#39;</span>: <span class="st">&#39;192.168.0.11&#39;</span>},</span>
<span id="cb3-19"><a href="#cb3-19"></a>                    {<span class="st">&#39;hostname&#39;</span>: <span class="st">&#39;192.168.10.11&#39;</span>, <span class="st">&#39;install&#39;</span>: <span class="ex">False</span>}],</span>
<span id="cb3-20"><a href="#cb3-20"></a> <span class="st">&#39;threads&#39;</span>: <span class="ex">1</span>}</span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="ex">_______________MERGED</span> DICT_____________</span>
<span id="cb3-22"><a href="#cb3-22"></a>[{<span class="st">&#39;confreg&#39;</span>: [<span class="st">&#39;0xF&#39;</span>, <span class="st">&#39;0x2102&#39;</span>, <span class="st">&#39;0x102&#39;</span>],</span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="st">&#39;fix_confreg&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-24"><a href="#cb3-24"></a>  <span class="st">&#39;hostname&#39;</span>: <span class="st">&#39;192.168.0.150&#39;</span>,</span>
<span id="cb3-25"><a href="#cb3-25"></a>  <span class="st">&#39;image_md5&#39;</span>: <span class="st">&#39;885ed3dd7278baa11538a51827c2c9f8&#39;</span>,</span>
<span id="cb3-26"><a href="#cb3-26"></a>  <span class="st">&#39;image_name&#39;</span>: <span class="st">&#39;c2960-lanlitek9-mz.150-2.SE11.bin&#39;</span>,</span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="st">&#39;install&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-28"><a href="#cb3-28"></a>  <span class="st">&#39;reload_max_time&#39;</span>: <span class="ex">24000</span>,</span>
<span id="cb3-29"><a href="#cb3-29"></a>  <span class="st">&#39;reload_shelf_rpr&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-30"><a href="#cb3-30"></a>  <span class="st">&#39;reload_verify&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-31"><a href="#cb3-31"></a>  <span class="st">&#39;remote_directory&#39;</span>: <span class="st">&#39;http://192.168.0.113/&#39;</span>},</span>
<span id="cb3-32"><a href="#cb3-32"></a> {<span class="st">&#39;confreg&#39;</span>: [<span class="st">&#39;0xF&#39;</span>, <span class="st">&#39;0x2102&#39;</span>, <span class="st">&#39;0x102&#39;</span>],</span>
<span id="cb3-33"><a href="#cb3-33"></a>  <span class="st">&#39;fix_confreg&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-34"><a href="#cb3-34"></a>  <span class="st">&#39;hostname&#39;</span>: <span class="st">&#39;192.168.0.11&#39;</span>,</span>
<span id="cb3-35"><a href="#cb3-35"></a>  <span class="st">&#39;image_md5&#39;</span>: <span class="st">&#39;1ac4728753bb11ad6f22fd8f54763f8e&#39;</span>,</span>
<span id="cb3-36"><a href="#cb3-36"></a>  <span class="st">&#39;image_name&#39;</span>: <span class="st">&#39;c2960-lanlitek9-mz.122-55.SE12.bin&#39;</span>,</span>
<span id="cb3-37"><a href="#cb3-37"></a>  <span class="st">&#39;install&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-38"><a href="#cb3-38"></a>  <span class="st">&#39;reload_max_time&#39;</span>: <span class="ex">24000</span>,</span>
<span id="cb3-39"><a href="#cb3-39"></a>  <span class="st">&#39;reload_shelf_rpr&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-40"><a href="#cb3-40"></a>  <span class="st">&#39;reload_verify&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-41"><a href="#cb3-41"></a>  <span class="st">&#39;remote_directory&#39;</span>: <span class="st">&#39;http://192.168.0.113/&#39;</span>},</span>
<span id="cb3-42"><a href="#cb3-42"></a> {<span class="st">&#39;confreg&#39;</span>: [<span class="st">&#39;0xF&#39;</span>, <span class="st">&#39;0x2102&#39;</span>, <span class="st">&#39;0x102&#39;</span>],</span>
<span id="cb3-43"><a href="#cb3-43"></a>  <span class="st">&#39;fix_confreg&#39;</span>: <span class="ex">True</span>,</span>
<span id="cb3-44"><a href="#cb3-44"></a>  <span class="st">&#39;hostname&#39;</span>: <span class="st">&#39;192.168.10.11&#39;</span>,</span>
<span id="cb3-45"><a href="#cb3-45"></a>  <span class="st">&#39;image_md5&#39;</span>: <span class="st">&#39;1ac4728753bb11ad6f22fd8f54763f8e&#39;</span>,</span>
<span id="cb3-46"><a href="#cb3-46"></a>  <span class="st">&#39;image_name&#39;</span>: <span class="st">&#39;c2960-lanlitek9-mz.122-55.SE12.bin&#39;</span>,</span>
<span id="cb3-47"><a href="#cb3-47"></a>  <span class="st">&#39;install&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-48"><a href="#cb3-48"></a>  <span class="st">&#39;reload_max_time&#39;</span>: <span class="ex">24000</span>,</span>
<span id="cb3-49"><a href="#cb3-49"></a>  <span class="st">&#39;reload_shelf_rpr&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-50"><a href="#cb3-50"></a>  <span class="st">&#39;reload_verify&#39;</span>: <span class="ex">False</span>,</span>
<span id="cb3-51"><a href="#cb3-51"></a>  <span class="st">&#39;remote_directory&#39;</span>: <span class="st">&#39;http://192.168.0.113/&#39;</span>}]</span></code></pre></div>
<p>As you can see, we’ve ended up with separate dictionaries for each device. At this point the script_settings list can be iterated over and each element of the list has a dictionary.</p>
<p>If you aren’t familiar with dictionaries, they operate on key-value pairs, wherein in the above pprint output the items to the left of the colon are keys and to the right are the values. I’ve founding using dictionaries where possible really improves the readability of my code and makes things much easier on me. In the example below, we iterate over the script_settings list and print the hostname and image_name from each of each device.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="cf">for</span> device_settings <span class="kw">in</span> script_settings:</span>
<span id="cb4-2"><a href="#cb4-2"></a>    </span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="bu">print</span>(device_settings[<span class="st">&#39;hostname&#39;</span>])</span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="bu">print</span>(device_settings[<span class="st">&#39;image_name&#39;</span>])</span></code></pre></div>
<p>Which outputs the following:</p>
<pre><code>192.168.0.150
c2960-lanlitek9-mz.150-2.SE11.bin
192.168.0.11
c2960-lanlitek9-mz.122-55.SE12.bin
192.168.10.11
c2960-lanlitek9-mz.122-55.SE12.bin</code></pre>
<p>I’ve found handling device specific script configuration in this way has been extremely powerful and a huge improvement over iterating through a file called ‘device_list.txt’.</p>
<p><em>Note: This note was originally on my personal blog. I’ve backdated the post to show the day it was originally written</em></p>
